import{u as le,r as c,a as V,j as e,H as oe}from"./app-DPeRIqfB.js";import{H as de}from"./heading-B72AwiIV.js";import{A as me,X as xe,C as R,a as he,s as pe}from"./app-layout-B4xE8Gmj.js";import{c as J,B as i}from"./app-logo-icon-BdMBwIB8.js";import{C as m,a as b,b as v,c as B,d as x}from"./card-oavSRO82.js";import{I as ue}from"./input-BSgN48L3.js";import{L as ge}from"./label-D_h8M4XR.js";import{S as je,a as fe,b as Ne,c as ye,d as be}from"./select-C5tYXfm4.js";import{S as ve}from"./separator-CcCJ9dmE.js";import{P as Ce}from"./plus-DM8L4IUB.js";import{S as U}from"./shopping-cart-CdK_jgZB.js";import{U as W}from"./user-DPXYUFzz.js";import{S as we}from"./search-Ch8a8ZqK.js";import{S as X}from"./save-DHVBOpDe.js";import{C as G}from"./circle-check-big-DvsHNhyO.js";/* empty css            */import"./index-CAnQaZOM.js";import"./index-J3mPrw_8.js";import"./index-BliOdkI6.js";import"./check-a6FarZSM.js";const Se=[["path",{d:"M8 3H5a2 2 0 0 0-2 2v3",key:"1dcmit"}],["path",{d:"M21 8V5a2 2 0 0 0-2-2h-3",key:"1e4gt3"}],["path",{d:"M3 16v3a2 2 0 0 0 2 2h3",key:"wsl5sc"}],["path",{d:"M16 21h3a2 2 0 0 0 2-2v-3",key:"18trek"}]],ke=J("Maximize",Se);const Pe=[["path",{d:"M8 3v3a2 2 0 0 1-2 2H3",key:"hohbtr"}],["path",{d:"M21 8h-3a2 2 0 0 1-2-2V3",key:"5jw1f3"}],["path",{d:"M3 16h3a2 2 0 0 1 2 2v3",key:"198tvr"}],["path",{d:"M16 21v-3a2 2 0 0 1 2-2h3",key:"ph8mxp"}]],Me=J("Minimize",Pe),Fe=[{title:"Point of Sale",href:"/pos"}];function Ke({products:K,members:u,pendingSaleEdit:g}){const{flash:k}=le().props,[P,Y]=c.useState(""),[j,Z]=c.useState(K),[C,M]=c.useState([]),[w,F]=c.useState(null),[Q,L]=c.useState(!1),q=c.useRef(null),a=C.find(s=>s.id===w)||null,l=a?.member_id||"",f=a?.payment_method||"cash",o=a?.items||[],ee=a?.notes||"",h=V({cart:[],member_id:"",total:0,payment_method:"cash"}),N=V({cart:[],member_id:"",total:0,notes:""}),T=c.useMemo(()=>P?j.filter(s=>s.name.toLowerCase().includes(P.toLowerCase())):j,[j,P]),I=async()=>{try{const s=await fetch("/pos/products",{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}});if(s.ok){const t=await s.json();Z(t.products||[])}}catch(s){console.error("Failed to refresh products:",s)}},S=c.useMemo(()=>o.reduce((s,t)=>s+t.subtotal,0),[o]),A=c.useMemo(()=>{if(!l)return!1;const s=u.find(t=>t.id.toString()===l);return s?Number(s.balance)<2e3:!1},[l,u]);c.useEffect(()=>{if(g){const s=g.items.map(r=>{const p=j.find(n=>n.id===r.product_id);return p?{id:r.product_id,product:p,quantity:r.quantity,subtotal:Number(r.total)||Number(p.selling_price)*r.quantity}:null}).filter(r=>r!==null),t={id:`edit-cart-${g.id}`,member_id:g.member_id?.toString()||"",items:s,payment_method:"cash",notes:g.notes||"",status:"active"};M([t]),F(t.id),fetch("/pos/clear-edit-session",{method:"POST"}).catch(()=>{})}},[g,j]);const E=(s="")=>{const t={id:`cart-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,member_id:s,items:[],payment_method:"cash",notes:"",status:"active"};M(r=>[...r,t]),F(t.id)},se=s=>{F(s)},_=s=>{if(M(t=>t.filter(r=>r.id!==s)),w===s){const t=C.filter(r=>r.id!==s);F(t.length>0?t[0].id:null)}},d=s=>{w&&M(t=>t.map(r=>r.id===w?{...r,...s}:r))};c.useEffect(()=>{C.length===0&&E()},[]),c.useEffect(()=>{a&&h.setData({cart:a.items.map(s=>({id:s.product.id,quantity:s.quantity})),member_id:a.member_id,total:S,payment_method:a.payment_method})},[a,S]);const te=s=>{if(!a){alert("Please create a cart first by selecting a member");return}const t=a.items.find(r=>r.product.id===s.id);if(t){if(t.quantity>=s.current_stock){alert(`Only ${s.current_stock} items available in stock`);return}z(s.id,t.quantity+1)}else{if(s.current_stock<1){alert("Product is out of stock");return}const r={id:Date.now(),product:s,quantity:1,subtotal:s.selling_price};d({items:[...a.items,r]})}},z=(s,t)=>{if(!a)return;if(t<=0){$(s);return}const r=j.find(n=>n.id===s);if(r&&t>r.current_stock){alert(`Only ${r.current_stock} items available in stock`);return}const p=a.items.map(n=>n.product.id===s?{...n,quantity:t,subtotal:n.product.selling_price*t}:n);d({items:p})},$=s=>{if(!a)return;const t=a.items.filter(r=>r.product.id!==s);d({items:t})},ae=()=>{a&&d({items:[],member_id:"",payment_method:"cash",notes:""})},H=()=>{if(!a||a.items.length===0){alert("Please add items to cart");return}N.setData({cart:a.items,member_id:a.member_id||"",total:S,payment_method:a.payment_method,notes:a.notes}),N.post("/pos/save-pending",{onSuccess:()=>{_(a.id),I()}})},O=()=>{if(!a||a.items.length===0){alert("Please add items to cart");return}if(a.payment_method==="pay_later"&&!a.member_id){alert("Please select a member for pay later option");return}d({status:"processing"}),h.setData({cart:a.items.map(s=>({id:s.product.id,quantity:s.quantity})),member_id:a.member_id,total:S,payment_method:a.payment_method}),h.post(pe(),{onSuccess:()=>{_(a.id),I()},onError:()=>{d({status:"active"})}})},re=s=>{d({member_id:s})},D=s=>{d({payment_method:s})},ne=s=>{d({notes:s})},y=s=>`${(typeof s=="string"?parseFloat(s):s).toFixed(2)} VT`,ce=()=>{document.fullscreenElement?document.exitFullscreen().then(()=>{L(!1)}).catch(s=>{console.error("Error attempting to exit fullscreen:",s)}):q.current&&q.current.requestFullscreen().then(()=>{L(!0)}).catch(s=>{console.error("Error attempting to enable fullscreen:",s)})};return c.useEffect(()=>{const s=()=>{L(document.fullscreenElement===q.current)};return document.addEventListener("fullscreenchange",s),()=>document.removeEventListener("fullscreenchange",s)},[]),e.jsxs(me,{breadcrumbs:Fe,children:[e.jsx(oe,{title:"Point of Sale"}),e.jsxs("div",{ref:q,className:"space-y-6 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(de,{title:"Point of Sale",description:"Process sales and manage transactions"}),e.jsx(i,{onClick:ce,variant:"outline",size:"sm",className:"flex items-center gap-2",children:Q?e.jsxs(e.Fragment,{children:[e.jsx(Me,{className:"h-4 w-4"}),"Exit Fullscreen"]}):e.jsxs(e.Fragment,{children:[e.jsx(ke,{className:"h-4 w-4"}),"Fullscreen"]})})]}),e.jsxs(m,{children:[e.jsx(b,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(v,{children:"Active Carts"}),e.jsx(B,{children:"Manage multiple customer transactions"})]}),e.jsxs(i,{onClick:()=>E(),variant:"outline",children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"New Cart"]})]})}),e.jsx(x,{children:C.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(U,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No active carts. Create a new cart to start."})]}):e.jsx("div",{className:"flex flex-wrap gap-2",children:C.map(s=>{const t=u.find(n=>n.id.toString()===s.member_id),r=s.items.reduce((n,ie)=>n+ie.subtotal,0),p=s.id===w;return e.jsxs("div",{className:`relative p-3 rounded-lg border-2 cursor-pointer transition-all ${p?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>se(s.id),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:t?t.name:"Walk-in"})]}),e.jsx(i,{size:"sm",variant:"ghost",onClick:n=>{n.stopPropagation(),_(s.id)},className:"h-6 w-6 p-0 text-red-500 hover:text-red-700",children:e.jsx(xe,{className:"h-3 w-3"})})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[s.items.length," items • ",y(r)]}),s.status==="processing"&&e.jsx("div",{className:"text-xs text-orange-600 mt-1",children:"Processing..."})]},s.id)})})})]}),a&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsx(m,{children:e.jsx(x,{className:"pt-6",children:e.jsxs("div",{className:"relative",children:[e.jsx(we,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(ue,{placeholder:"Search products...",value:P,onChange:s=>Y(s.target.value),className:"pl-10"})]})})}),e.jsxs(m,{children:[e.jsxs(b,{children:[e.jsxs(v,{children:["Products (",T.length,")"]}),e.jsx(B,{children:"Click on products to add to cart"})]}),e.jsxs(x,{children:[e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4",children:T.map(s=>e.jsxs("div",{className:"border rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition-colors",onClick:()=>te(s),children:[e.jsx("h3",{className:"font-medium text-sm mb-1",children:s.name}),e.jsx("p",{className:"text-lg font-bold text-green-600 mb-2",children:y(s.selling_price)}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Stock: ",s.current_stock]})]},s.id))}),T.length===0&&e.jsx("p",{className:"text-center text-gray-500 py-8",children:"No products found"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(m,{children:[e.jsx(b,{children:e.jsxs(v,{className:"flex items-center gap-2",children:[e.jsx(U,{className:"h-5 w-5"}),"Cart (",o.length,")"]})}),e.jsx(x,{className:"space-y-4",children:o.length===0?e.jsx("p",{className:"text-center text-gray-500 py-4",children:"Cart is empty"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:o.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium",children:s.product.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[y(s.product.selling_price)," each"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(i,{size:"sm",variant:"outline",onClick:()=>z(s.product.id,s.quantity-1),children:"-"}),e.jsx("span",{className:"w-8 text-center",children:s.quantity}),e.jsx(i,{size:"sm",variant:"outline",onClick:()=>z(s.product.id,s.quantity+1),children:"+"}),e.jsx(i,{size:"sm",variant:"destructive",onClick:()=>$(s.product.id),children:"×"})]})]},s.id))}),e.jsx(ve,{}),e.jsxs("div",{className:"flex justify-between items-center font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-lg text-green-600",children:y(S)})]}),e.jsx(i,{variant:"outline",onClick:ae,className:"w-full",children:"Clear Cart"})]})})]}),e.jsxs(m,{children:[e.jsx(b,{children:e.jsxs(v,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"h-5 w-5"}),"Member"]})}),e.jsxs(x,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(ge,{htmlFor:"member",children:"Select Member (Optional)"}),e.jsxs(je,{value:l,onValueChange:re,children:[e.jsx(fe,{children:e.jsx(Ne,{placeholder:"Walk-in customer"})}),e.jsx(ye,{children:u.map(s=>{const r=(typeof s.balance=="string"?parseFloat(s.balance):s.balance)>=2e3;return e.jsx(be,{value:s.id.toString(),className:r?"text-red-600 bg-red-50":"",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:s.name}),e.jsxs("span",{className:`text-xs ${r?"text-red-600 font-semibold":"text-gray-500"}`,children:[y(s.balance)," unpaid"]})]})},s.id)})})]})]}),l&&e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium",children:"Selected Member:"}),e.jsx("p",{className:"text-sm",children:u.find(s=>s.id.toString()===l)?.name}),e.jsxs("p",{className:"text-xs text-gray-600",children:["Current balance: ",y(u.find(s=>s.id.toString()===l)?.balance||0)]})]})]})]}),e.jsxs(m,{children:[e.jsx(b,{children:e.jsxs(v,{className:"flex items-center gap-2",children:[e.jsx(R,{className:"h-5 w-5"}),"Payment Method"]})}),e.jsxs(x,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs(i,{variant:f==="cash"?"default":"outline",onClick:()=>D("cash"),className:"flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4"}),"Cash"]}),e.jsxs(i,{variant:f==="pay_later"?"default":"outline",onClick:()=>D("pay_later"),disabled:!l||!A,className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4"}),"Pay Later"]})]}),f==="pay_later"&&l&&!A&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-red-600 font-medium",children:'Member cannot use "Pay Later" option'}),e.jsx("p",{className:"text-xs text-red-600",children:"Unpaid amount is 2000 VT or more"})]}),f==="pay_later"&&!l&&e.jsx("div",{className:"p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-yellow-600 font-medium",children:'Select a member to use "Pay Later"'})})]})]}),e.jsxs(m,{children:[e.jsx(b,{children:e.jsx(v,{className:"text-sm",children:"Transaction Notes (Optional)"})}),e.jsx(x,{children:e.jsx("textarea",{className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"Add notes for this transaction...",value:ee,onChange:s=>ne(s.target.value),rows:2})})]}),e.jsx(m,{children:e.jsxs(x,{className:"pt-6 space-y-3",children:[f==="pay_later"?e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs(i,{onClick:H,disabled:o.length===0||N.processing,size:"lg",className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4"}),N.processing?"Saving...":"Save for Later"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"Items will be handed over, payment collected later"})]}):f==="cash"?e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs(i,{onClick:O,disabled:o.length===0||h.processing,size:"lg",className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4"}),h.processing?"Processing...":"Complete Sale"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"Process payment and complete transaction"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(i,{onClick:H,disabled:o.length===0||N.processing,variant:"outline",size:"lg",className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4"}),N.processing?"Saving...":"Save"]}),e.jsxs(i,{onClick:O,disabled:o.length===0||h.processing,size:"lg",className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4"}),h.processing?"Processing...":"Complete"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs text-gray-500",children:[e.jsx("p",{className:"text-center",children:"Save for later processing"}),e.jsx("p",{className:"text-center",children:"Complete sale now"})]})]}),k?.success&&e.jsx("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-green-600",children:k.success})}),k?.error&&e.jsx("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-red-600",children:k.error})})]})})]})]})]})]})}export{Ke as default};
