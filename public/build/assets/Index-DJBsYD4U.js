import{u as ve,a as n,b as X,j as e,H as Ce,r as J}from"./app-38lvqsZi.js";import{H as we}from"./heading-DZfmFNTY.js";import{A as Se,X as G,S as $,U as K,a as Y,C as ke,D as Z,s as Pe,b as Fe}from"./app-layout-aoZEk1tT.js";import{c as ae,B as c}from"./app-logo-icon-D3-YZjDB.js";import{C as g,b as w,c as S,d as Q,a as j}from"./card-Ddlm6lvt.js";import{I as ee}from"./input-BAVwmEoI.js";import{L as H}from"./label-C6uE05tf.js";import{d as _e,a as Me,b as De,c as qe,S as Ie}from"./select-DM--AAJW.js";import{S as Te}from"./separator-Dgt8imYn.js";import{D as Le,a as Ae,b as Ee,c as ze,d as $e}from"./dialog-DAn2UFrC.js";import{P as se}from"./plus-Dy58tXI9.js";import{S as He}from"./search-Z2pKWY6O.js";import{S as te}from"./save-CskIi-FF.js";import{C as Oe}from"./circle-check-big--PqiIOig.js";/* empty css            */import"./index-Cfsd8eXM.js";import"./index-C-byGbbM.js";import"./index-Cq18JqvT.js";import"./check-Bp6U0sMP.js";const Re=[["path",{d:"M8 3H5a2 2 0 0 0-2 2v3",key:"1dcmit"}],["path",{d:"M21 8V5a2 2 0 0 0-2-2h-3",key:"1e4gt3"}],["path",{d:"M3 16v3a2 2 0 0 0 2 2h3",key:"wsl5sc"}],["path",{d:"M16 21h3a2 2 0 0 0 2-2v-3",key:"18trek"}]],Ue=ae("Maximize",Re);const Ve=[["path",{d:"M8 3v3a2 2 0 0 1-2 2H3",key:"hohbtr"}],["path",{d:"M21 8h-3a2 2 0 0 1-2-2V3",key:"5jw1f3"}],["path",{d:"M3 16h3a2 2 0 0 1 2 2v3",key:"198tvr"}],["path",{d:"M16 21v-3a2 2 0 0 1 2-2h3",key:"ph8mxp"}]],We=ae("Minimize",Ve),Be=[{title:"Point of Sale",href:"/pos"}];function xs({products:re,members:N,pendingSaleEdit:y}){const{flash:F}=ve().props,[_,ne]=n.useState(""),[b,ce]=n.useState(re),[f,k]=n.useState(()=>{if(typeof window<"u"){const s=localStorage.getItem("pos_carts");return s?JSON.parse(s):[]}return[]}),[u,P]=n.useState(()=>typeof window<"u"?localStorage.getItem("pos_active_cart_id"):null),[le,q]=n.useState(!1),M=n.useRef(null),[ie,I]=n.useState(!1),[m,T]=n.useState(""),t=f.find(s=>s.id===u)||null,d=t?.member_id||"",v=t?.payment_method||"cash",p=t?.items||[],oe=t?.notes||"",C=X({cart:[],member_id:"",total:0,payment_method:"cash"}),O=X({cart:[],member_id:"",total:0,payment_method:"cash",notes:""}),L=n.useMemo(()=>_?b.filter(s=>s.name.toLowerCase().includes(_.toLowerCase())):b,[b,_]),A=async()=>{try{const s=await fetch("/pos/products",{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}});if(s.ok){const a=await s.json();ce(a.products||[])}}catch(s){console.error("Failed to refresh products:",s)}},i=n.useMemo(()=>p.reduce((s,a)=>s+a.subtotal,0),[p]),R=n.useMemo(()=>{if(!d)return!1;const s=N.find(a=>a.id.toString()===d);return s?Number(s.balance)<2e3:!1},[d,N]);n.useEffect(()=>{typeof window<"u"&&localStorage.setItem("pos_carts",JSON.stringify(f))},[f]),n.useEffect(()=>{typeof window<"u"&&(u?localStorage.setItem("pos_active_cart_id",u):localStorage.removeItem("pos_active_cart_id"))},[u]),n.useEffect(()=>{if(y&&!t){const s=y.items.map(r=>{const o=b.find(l=>l.id===r.product_id);return o?{id:r.product_id,product:o,quantity:r.quantity,subtotal:Number(r.total)||Number(o.selling_price)*r.quantity}:null}).filter(r=>r!==null),a={id:`edit-cart-${y.id}`,member_id:y.member_id?.toString()||"",items:s,payment_method:"cash",notes:y.notes||"",status:"active"};k([a]),P(a.id)}},[y,b,t]);const U=(s="")=>{const a={id:`cart-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,member_id:s,items:[],payment_method:"cash",notes:"",status:"active"};k(r=>[...r,a]),P(a.id)},de=s=>{P(s)},D=s=>{if(k(a=>a.filter(r=>r.id!==s)),u===s){const a=f.filter(r=>r.id!==s);P(a.length>0?a[0].id:null)}},me=()=>{k([]),P(null),typeof window<"u"&&(localStorage.removeItem("pos_carts"),localStorage.removeItem("pos_active_cart_id"))},x=s=>{u&&k(a=>a.map(r=>r.id===u?{...r,...s}:r))};n.useEffect(()=>{t&&C.setData({cart:t.items.map(s=>({id:s.product.id,quantity:s.quantity})),member_id:t.member_id,total:i,payment_method:t.payment_method})},[t,i]);const xe=s=>{if(!t){alert("Please create a cart first by selecting a member");return}const a=t.items.find(r=>r.product.id===s.id);if(a){if(a.quantity>=s.current_stock){alert(`Only ${s.current_stock} items available in stock`);return}E(s.id,a.quantity+1)}else{if(s.current_stock<1){alert("Product is out of stock");return}const r={id:Date.now(),product:s,quantity:1,subtotal:Number(s.selling_price)};x({items:[...t.items,r]})}},E=(s,a)=>{if(!t)return;if(a<=0){V(s);return}const r=b.find(l=>l.id===s);if(r&&a>r.current_stock){alert(`Only ${r.current_stock} items available in stock`);return}const o=t.items.map(l=>l.product.id===s?{...l,quantity:a,subtotal:Number(l.product.selling_price)*a}:l);x({items:o})},V=s=>{if(!t)return;const a=t.items.filter(r=>r.product.id!==s);x({items:a})},he=()=>{t&&x({items:[],member_id:"",payment_method:"cash",notes:""})},ue=()=>{if(!t||t.items.length===0){alert("Please add items to cart");return}const a={cart:t.items.map(r=>({id:r.product.id,quantity:r.quantity})),member_id:t.member_id||"",total:Number(i),payment_method:t.payment_method,notes:t.notes};console.log("Saving for later with data:",a),J.post(Pe().url,a,{onSuccess:()=>{D(t.id),A()},onError:r=>{console.error("Save for later failed:",r),alert("Failed to save transaction. Please try again.")}})},W=t?.id.startsWith("edit-cart-")||!1,pe=()=>{if(!t||t.items.length===0){alert("Please add items to cart");return}const s=t.id.replace("edit-cart-",""),r={cart:t.items.map(o=>({id:o.product.id,quantity:o.quantity})),member_id:t.member_id||"",total:Number(i),payment_method:t.payment_method,notes:t.notes};console.log("Updating pending transaction:",s,r),J.post(`/pending-sales/${s}/update`,r,{onSuccess:()=>{D(t.id),A()},onError:o=>{console.error("Update failed:",o),alert("Failed to update transaction. Please try again.")}})},ge=()=>{T(""),I(!0)},z=()=>{I(!1),T("")},je=()=>{if(!t||t.items.length===0){alert("Please add items to cart");return}const s=parseFloat(m);if(isNaN(s)||s<i){alert("Received cash must be at least the total amount");return}x({status:"processing"}),C.setData({cart:t.items.map(a=>({id:a.product.id,quantity:a.quantity})),member_id:t.member_id,total:i,payment_method:"cash"}),C.post(Fe().url,{onSuccess:()=>{D(t.id),A(),z()},onError:()=>{x({status:"active"}),z()}})},fe=s=>{x({member_id:s})},B=s=>{x({payment_method:s})},Ne=s=>{x({notes:s})},h=s=>`${(typeof s=="string"?parseFloat(s):s).toFixed(2)} VT`,ye=()=>{document.fullscreenElement?document.exitFullscreen().then(()=>{q(!1)}).catch(s=>{console.error("Error attempting to exit fullscreen:",s)}):M.current&&M.current.requestFullscreen().then(()=>{q(!0)}).catch(s=>{console.error("Error attempting to enable fullscreen:",s)})};return n.useEffect(()=>{const s=()=>{q(document.fullscreenElement===M.current)};return document.addEventListener("fullscreenchange",s),()=>document.removeEventListener("fullscreenchange",s)},[]),e.jsxs(Se,{breadcrumbs:Be,children:[e.jsx(Ce,{title:"Point of Sale"}),e.jsxs("div",{ref:M,className:"space-y-6 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(we,{title:"Point of Sale",description:"Process sales and manage transactions"}),e.jsx(c,{onClick:ye,variant:"outline",size:"sm",className:"flex items-center gap-2",children:le?e.jsxs(e.Fragment,{children:[e.jsx(We,{className:"h-4 w-4"}),"Exit Fullscreen"]}):e.jsxs(e.Fragment,{children:[e.jsx(Ue,{className:"h-4 w-4"}),"Fullscreen"]})})]}),e.jsxs(g,{children:[e.jsx(w,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(S,{children:"Active Carts"}),e.jsx(Q,{children:"Manage multiple customer transactions"})]}),e.jsxs("div",{className:"flex gap-2",children:[f.length>0&&e.jsxs(c,{onClick:me,variant:"outline",size:"sm",children:[e.jsx(G,{className:"h-4 w-4 mr-2"}),"Clear All"]}),e.jsxs(c,{onClick:()=>U(),variant:"outline",children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"New Cart"]})]})]})}),e.jsx(j,{children:f.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx($,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No active carts. Create a new cart to start."})]}):e.jsx("div",{className:"flex flex-wrap gap-2",children:f.map(s=>{const a=N.find(l=>l.id.toString()===s.member_id),r=s.items.reduce((l,be)=>l+be.subtotal,0),o=s.id===u;return e.jsxs("div",{className:`relative p-3 rounded-lg border-2 cursor-pointer transition-all ${o?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>de(s.id),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:a?a.name:"Walk-in"})]}),e.jsx(c,{size:"sm",variant:"ghost",onClick:l=>{l.stopPropagation(),D(s.id)},className:"h-6 w-6 p-0 text-red-500 hover:text-red-700",children:e.jsx(G,{className:"h-3 w-3"})})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[s.items.length," items • ",h(r)]}),s.status==="processing"&&e.jsx("div",{className:"text-xs text-orange-600 mt-1",children:"Processing..."})]},s.id)})})})]}),t&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsx(g,{children:e.jsx(j,{className:"pt-6",children:e.jsxs("div",{className:"relative",children:[e.jsx(He,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(ee,{placeholder:"Search products...",value:_,onChange:s=>ne(s.target.value),className:"pl-10"})]})})}),e.jsxs(g,{children:[e.jsxs(w,{children:[e.jsxs(S,{children:["Products (",L.length,")"]}),e.jsx(Q,{children:"Click on products to add to cart"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4",children:L.map(s=>e.jsxs("div",{className:"border rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition-colors",onClick:()=>xe(s),children:[e.jsx("h3",{className:"font-medium text-sm mb-1",children:s.name}),e.jsx("p",{className:"text-lg font-bold text-green-600 mb-2",children:h(s.selling_price)}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Stock: ",s.current_stock]})]},s.id))}),L.length===0&&e.jsx("p",{className:"text-center text-gray-500 py-8",children:"No products found"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(g,{children:[e.jsx(w,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx($,{className:"h-5 w-5"}),t?`Cart (${p.length})`:"No Active Cart"]})}),e.jsx(j,{className:"space-y-4",children:t?p.length===0?e.jsx("p",{className:"text-center text-gray-500 py-4",children:"Cart is empty"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:p.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium",children:s.product.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[h(s.product.selling_price)," each"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{size:"sm",variant:"outline",onClick:()=>E(s.product.id,s.quantity-1),children:"-"}),e.jsx("span",{className:"w-8 text-center",children:s.quantity}),e.jsx(c,{size:"sm",variant:"outline",onClick:()=>E(s.product.id,s.quantity+1),children:"+"}),e.jsx(c,{size:"sm",variant:"destructive",onClick:()=>V(s.product.id),children:"×"})]})]},s.id))}),e.jsx(Te,{}),e.jsxs("div",{className:"flex justify-between items-center font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-lg text-green-600",children:h(i)})]}),e.jsx(c,{variant:"outline",onClick:he,className:"w-full",children:"Clear Cart"})]}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx($,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No active cart. Create a new cart to start adding items."}),e.jsxs(c,{onClick:()=>U(),className:"mt-4",children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"New Cart"]})]})})]}),e.jsxs(g,{children:[e.jsx(w,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-5 w-5"}),"Member"]})}),e.jsxs(j,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(H,{htmlFor:"member",children:"Select Member (Optional)"}),e.jsxs(_e,{value:d,onValueChange:fe,children:[e.jsx(Me,{children:e.jsx(De,{placeholder:"Walk-in customer"})}),e.jsx(qe,{children:N.map(s=>{const r=(typeof s.balance=="string"?parseFloat(s.balance):s.balance)>=2e3;return e.jsx(Ie,{value:s.id.toString(),className:r?"text-red-600 bg-red-50":"",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:s.name}),e.jsxs("span",{className:`text-xs ${r?"text-red-600 font-semibold":"text-gray-500"}`,children:[h(s.balance)," unpaid"]})]})},s.id)})})]})]}),d&&e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium",children:"Selected Member:"}),e.jsx("p",{className:"text-sm",children:N.find(s=>s.id.toString()===d)?.name}),e.jsxs("p",{className:"text-xs text-gray-600",children:["Current balance: ",h(N.find(s=>s.id.toString()===d)?.balance||0)]})]})]})]}),t&&e.jsxs(e.Fragment,{children:[!W&&e.jsx(e.Fragment,{children:e.jsxs(g,{children:[e.jsx(w,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"h-5 w-5"}),"Payment Method"]})}),e.jsxs(j,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs(c,{variant:v==="cash"?"default":"outline",onClick:()=>B("cash"),className:"flex items-center gap-2",children:[e.jsx(Y,{className:"h-4 w-4"}),"Cash"]}),e.jsxs(c,{variant:v==="pay_later"?"default":"outline",onClick:()=>B("pay_later"),disabled:!d||!R,className:"flex items-center gap-2",children:[e.jsx(ke,{className:"h-4 w-4"}),"Pay Later"]})]}),v==="pay_later"&&d&&!R&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-red-600 font-medium",children:'Member cannot use "Pay Later" option'}),e.jsx("p",{className:"text-xs text-red-600",children:"Unpaid amount is 2000 VT or more"})]}),v==="pay_later"&&!d&&e.jsx("div",{className:"p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-yellow-600 font-medium",children:'Select a member to use "Pay Later"'})})]})]})}),e.jsxs(g,{children:[e.jsx(w,{children:e.jsx(S,{className:"text-sm",children:"Transaction Notes (Optional)"})}),e.jsx(j,{children:e.jsx("textarea",{className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"Add notes for this transaction...",value:oe,onChange:s=>Ne(s.target.value),rows:2})})]}),e.jsx(g,{children:e.jsx(j,{className:"pt-6 space-y-3",children:W?e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg mb-4",children:[e.jsxs("p",{className:"text-sm text-blue-600 font-medium",children:["Editing Pending Transaction #",t.id.replace("edit-cart-","")]}),e.jsxs("p",{className:"text-xs text-blue-600",children:["Payment method: ",t.payment_method==="pay_later"?"Pay Later":"Cash"]})]}),e.jsxs(c,{onClick:pe,disabled:p.length===0,size:"lg",className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-4 w-4"}),"Update Transaction"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"Update the pending transaction with your changes"})]}):v==="pay_later"?e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs(c,{onClick:ue,disabled:p.length===0||O.processing,size:"lg",className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-4 w-4"}),O.processing?"Saving...":"Save for Later"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"Items will be handed over, payment collected later"})]}):v==="cash"?e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs(c,{onClick:ge,disabled:p.length===0,size:"lg",className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-4 w-4"}),"Pay Now"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"Process cash payment and calculate change"})]}):e.jsx("div",{className:"text-center space-y-3",children:e.jsx("div",{className:"p-3 bg-gray-50 border border-gray-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-gray-600",children:"Select a payment method to continue"})})})})}),F?.success&&e.jsx("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-green-600",children:F.success})}),F?.error&&e.jsx("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-red-600",children:F.error})})]})]})]})]}),e.jsx(Le,{open:ie,onOpenChange:I,children:e.jsxs(Ae,{className:"sm:max-w-md",children:[e.jsx(Ee,{children:e.jsxs(ze,{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-5 w-5"}),"Cash Payment"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"total-amount",children:"Total Amount"}),e.jsx("div",{className:"text-2xl font-bold text-green-600",children:h(i)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"received-cash",children:"Received Cash"}),e.jsx(ee,{id:"received-cash",type:"number",step:"0.01",placeholder:"Enter received cash amount",value:m,onChange:s=>T(s.target.value),className:"text-lg",autoFocus:!0})]}),m&&parseFloat(m)>=i&&e.jsx("div",{className:"space-y-2 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:"Change to return:"}),e.jsx("span",{className:"text-xl font-bold text-blue-600",children:h(parseFloat(m)-i)})]})}),m&&parseFloat(m)<i&&e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-red-600",children:["Insufficient amount. Need at least ",h(i)]})})]}),e.jsxs($e,{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",onClick:z,disabled:C.processing,children:"Cancel"}),e.jsxs(c,{onClick:je,disabled:!m||parseFloat(m)<i||C.processing,className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"h-4 w-4"}),C.processing?"Processing...":"Complete Transaction"]})]})]})})]})}export{xs as default};
